openapi: 3.0.3
info:
  title: FantasyManager Engine
  version: 1.0.0
servers:
  - url: http://engine:8000

paths:
  /v1/health:
    get:
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties: { ok: { type: boolean } }

  /v1/ingest/league:
    post:
      summary: Ingest league teams/rosters/settings
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LeagueIngest' }
            examples:
              minimal:
                value:
                  teams:
                    - { id: "t-001", name: "Kirat FC", manager: "Kirat" }
                  rosters:
                    - { team_id: "t-001", player_id: "p-123", slot: "RB" }
                  settings:
                    scoring_json: { pass_td: 4, rush_td: 6 }
                    roster_rules_json: { QB: 1, RB: 2, WR: 2, TE: 1, FLEX: 1, BN: 6 }
                    faab_budget: 200
      responses:
        '204': { description: Accepted }
        '400': { $ref: '#/components/responses/BadRequest' }

  /v1/compute/valuations:
    post:
      summary: Recompute player valuations (VORP)
      description: Starts an async job to compute valuations.
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                week: { type: integer, minimum: 1, maximum: 18 }
                source: { type: string, description: "projection source id" }
      responses:
        '202':
          description: Job accepted
          headers:
            Location:
              description: URL of the submitted job
              schema: { type: string }
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id: { type: string }
        '400': { $ref: '#/components/responses/BadRequest' }

  /v1/jobs/{job_id}:
    get:
      summary: Get job status/result
      parameters:
        - in: path
          name: job_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatus'
        '404': { $ref: '#/components/responses/NotFound' }

  /v1/recommend/free-agents:
    get:
      summary: Get best free-agent pickups for a team
      parameters:
        - in: query
          name: team_id
          required: true
          schema: { type: string }
        - in: query
          name: week
          schema: { type: integer, minimum: 1, maximum: 18 }
        - in: query
          name: limit
          schema: { type: integer, default: 10, minimum: 1, maximum: 50 }
        - in: query
          name: cursor
          schema: { type: string, description: "opaque paging cursor" }
      responses:
        '200':
          description: Ranked suggestions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedFaSuggestions'
        '400': { $ref: '#/components/responses/BadRequest' }
        '404': { $ref: '#/components/responses/NotFound' }

  /v1/recommend/trades:
    post:
      summary: Generate trade offers that improve your team
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [team_id]
              properties:
                team_id: { type: string }
                week: { type: integer, minimum: 1, maximum: 18 }
                max_offers_per_opponent: { type: integer, default: 2, minimum: 1, maximum: 10 }
                aggressiveness: { type: string, enum: [conservative, neutral, aggressive], default: neutral }
      responses:
        '200':
          description: Trade suggestions
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TradeSuggestion' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '404': { $ref: '#/components/responses/NotFound' }

  /v1/players:
    get:
      summary: List players with optional filters
      parameters:
        - in: query
          name: pos
          schema: { type: string, enum: [QB,RB,WR,TE,K,DST,FLX] }
        - in: query
          name: team
          schema: { type: string }
        - in: query
          name: week
          schema: { type: integer, minimum: 1, maximum: 18 }
        - in: query
          name: limit
          schema: { type: integer, default: 50, minimum: 1, maximum: 200 }
        - in: query
          name: cursor
          schema: { type: string }
      responses:
        '200':
          description: Players list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedPlayers'

  /v1/teams/{id}:
    get:
      summary: Get team roster and score
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - in: query
          name: week
          schema: { type: integer, minimum: 1, maximum: 18 }
      responses:
        '200':
          description: Team view
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamView'
        '404': { $ref: '#/components/responses/NotFound' }

  /v1/projections/sources:
    get:
      summary: List available projection sources
      responses:
        '200':
          description: Sources
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id: { type: string }
                    name: { type: string }
                    description: { type: string }

components:
  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
    NotFound:
      description: Not found
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }

  schemas:
    Error:
      type: object
      required: [error]
      properties:
        error: { type: string }
        details: { type: object, additionalProperties: true }

    LeagueIngest:
      type: object
      required: [teams, rosters, settings]
      properties:
        teams:
          type: array
          items: { $ref: '#/components/schemas/Team' }
        rosters:
          type: array
          items: { $ref: '#/components/schemas/Roster' }
        settings:
          type: object
          description: "scoring_json, roster_rules_json, faab_budget, etc."
          additionalProperties: true

    Team:
      type: object
      required: [id, name]
      properties:
        id: { type: string }
        name: { type: string }
        manager: { type: string }

    Roster:
      type: object
      required: [team_id, player_id, slot]
      properties:
        team_id: { type: string }
        player_id: { type: string }
        slot: { type: string, description: "QB/RB/WR/TE/FLEX/BN/IR" }

    Player:
      type: object
      required: [id, name, pos, team]
      properties:
        id: { type: string }
        ext_id: { type: string, description: "external provider id" }
        name: { type: string }
        pos: { type: string, enum: [QB,RB,WR,TE,K,DST] }
        team: { type: string }
        bye_week: { type: integer, minimum: 1, maximum: 18 }
        status: { type: string }

    PlayerValuation:
      type: object
      properties:
        player_id: { type: string }
        week: { type: integer }
        vorp: { type: number, format: float }
        rank_pos: { type: integer }
        rank_overall: { type: integer }

    PagedPlayers:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/Player' }
        cursor: { type: string, nullable: true }

    FaSuggestion:
      type: object
      required: [player_id, delta_value]
      properties:
        player_id: { type: string }
        delta_value: { type: number, format: float }
        suggested_faab: { type: integer }
        rationale: { type: string }

    PagedFaSuggestions:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/FaSuggestion' }
        cursor: { type: string, nullable: true }

    TradeSuggestion:
      type: object
      required: [opponent_team_id, give, get, delta_you, delta_them]
      properties:
        opponent_team_id: { type: string }
        give:
          type: array
          items: { type: string, description: "player_id" }
        get:
          type: array
          items: { type: string, description: "player_id" }
        delta_you: { type: number, format: float }
        delta_them: { type: number, format: float }
        rationale: { type: string }

    TeamView:
      type: object
      properties:
        team: { $ref: '#/components/schemas/Team' }
        roster:
          type: array
          items:
            type: object
            properties:
              player: { $ref: '#/components/schemas/Player' }
              slot: { type: string }
              valuation: { $ref: '#/components/schemas/PlayerValuation' }
        team_score: { type: number, format: float }

    JobStatus:
      type: object
      properties:
        id: { type: string }
        status: { type: string, enum: [queued, running, done, failed] }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
        result_ref:
          type: object
          nullable: true
          description: "Optional link to affected resource(s)"
          additionalProperties: true
        error: { $ref: '#/components/schemas/Error' }
